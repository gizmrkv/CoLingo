# CoLingo: Cooperation, Communication and Consensus Language Emergence

## TODO
- Agent interfaceでinput(dict), output(hidden, *outputs)を指定する
  - 変更範囲
    - Agent
    - Task
    - Model
    - main 
- Metricがnameを持ち，返り値の辞書に反映する
- freeze model
- Task
  - Speech
  - Telephon
  - Conversion
  - Parrot
  - 
- documentation
  - torchtyping, typeguard, pytest
  - configファイルを1回通してチェックする
- Metrics
  - Stability
  - (Async)
  - テストのためにハンドメイド言語を用意する
- OpenAI Gym task
- 混合精度
- Evaluator
  - 学習中に定期的に実行する？セーブしたモデルをロードして計算する？
- Network
  - Bipartite network
- モデルをロードしてメトリクスを計算する
  1. 学習の終了時 or 任意のタイミングで起動
  2. モデルのあるディレクトリを指定
  3. 
- Periodic model initializer
  - agentの初期化をこれに担当させちゃう？
- Faction
- Image input
- channel noise
  - メッセージの記号をランダムに書き換える
  - 特定の記号ペアは入れ替わりやすい
  - メッセージを前か後にシフトする（話し始めを聞きそびれる的な）
- パラメータ初期化方法をコンフィグファイルから指定
- Actor-Critic
- ハンドメイド言語
  - 整数と記号が1対1
  - 常に同じ1文字
- num_workers = 2 (num_workersの数だけGPUが必要かもしれない)

## メモ

Numbaを使ったscipyのspearmanrの高速化は3倍ほど遅くなる結果に終わった．
これはspearmanrの内部ではfor文を使わずにnumpyの関数のみを使っていたことが理由だろう．
一方，scipyのpdistはfor文を使っているため，Numbaで1.5倍ほど高速化できた．

ヒトの感覚器官は常に外界からの刺激を受け取っており，目的や目標を達成する上で重要かどうかを常に取捨選択し続けている．
例．
テストを受けるとき，「自分で問題を解いて高得点を取りたい」ヒトにとって問題を読むために目からの刺激は重要だろうが，書く音や監視員のいびきなどの耳からの刺激は重要ではない．一方で，「監視員の隙をついてカンニングしたい」にとっては音も重要だろう．

この環境と目的のペアに対して，どの情報が重要かの判断は初心者にとって難しい．
例．Apex Legendsをプレイする上でのプレイヤーの目的は「勝ち残ること」．初心者は敵との打ち合いに執心するだろうが，上級者は敵の位置や動き，パーティの残り人数，経過時間などを重視する．

初心者は環境からの刺激と目的を受け取り，次に何をするかを判断することを学習する必要がある．

今回の実験では目的は「自身と他AgentがConceptを正答すること」で確定ゆえ指定する必要はないだろう．環境刺激のうちどれが重要化を判断してほしい．

1. ダミーフラグを付けてあげる
    このときの刺激はゼロ埋め？ランダム？
    受け取った刺激が重要かどうかの判断をしてあげる．
    Agentは刺激ではなくダミーフラグを使って，刺激が無意味かどうかを判断する．

2. ランダム埋め
   message ダミーを考える．Agentは環境音と相手の発話を聞き分ける必要がある．
   環境音vocabを音vocabのsubsetとしよう．subset内からのランダム生成をダミーとする．
   concept
   

Agentへの引数の渡し方，返り値の受け取り方
辞書を使って，Agentの引数を渡す．この時点では推論しない
どの返り値がほしいかを整数で指定し，Agentの返り値を受け取る．このときに指定されたものだけ推論する．

Agentは複数の入力を受け取り，複数の出力をする．
TaskはデータをAgentのどの入力にわたすかを指定せねばならない．
どの入力に渡すかをTaskが決めてしまうと，TaskはAgentに特殊化していまう．不便
複数種類のAgentにそれぞれ複数種類の入力と複数種類の出力，複数種類のTaskが存在する．
Agent-Task間のデータの受け渡しに規則が必要，インターフェース
Task→Agent：Agentのどの入力にどんな値を入れるか．
Agent→Task：Agentのどの出力をどんな値として受け取るか．
Agentの入出力の名前を決めておくことで，新しくAgentを作るときに何に対応せねばならないかがわかる．
新しくTaskを作るときは，Agentのどの入力にデータを渡すか，どの出力を受け取るかを外から指定してもらうが，
指定する側はどの名前で指定するかをAgent規則を見ることで容易にわかる．
AgentIO

AgentにAgentIOで指定して値を入力すると，出力時に必要な情報を返す．これの型はTaskは知らない．
Agentは辞書やカスタムデータクラスで返す．
TaskはAgentIOで出力を指定して受け取った内部情報を渡すことで最終的な出力を得る．
入力時はAgentIOから値へのマッピング
出力時はAgentIOのリストと内部情報
inputs = {self.x: x, self.y: y}
internal = agent.input(**inputs)
a, b, c = agent.output(AgentIO.A, AgentIO.B, AgentIO.C, internal=internal)

でもこれAgentIOに新しく追加すると既存のAgentは動かなくなる？
引数にAgentIOの文字列を書かないことで，そのIOには対応していないことを明示できるからOK．

AgentIOはAgentごとにカスタムする？
全Agentで共通のAgentIOを使うと，新たに要素を追加するにはライブラリを編集しないといけない．
→Taskは文字列を受け取る．引数名として使用．


## 考察

無言期
はじめは喋るとペナルティかかるから何もしゃべらない

語彙爆発期
そこからなにか喋ると報酬が与えらることに気づく．Receiverは即時に対応できる．
SenderがConceptに対してMessageを作るとき，このMessageがほかのConceptに使うかは気にしない．喋って報酬が与えられなかったとき，単に別のメッセージを作ろうとするが，使われていないMessageを作らないと正答率は上がらない．

停滞期
学習が進んだあと，0.02%ぐらいから進まない頃，Senderが異なるConceptを同じMessageに割り当てちゃう．ReceiverがカバーできないからSenderが強化学習でなんとかしないといけないけど時間がかかる．

### 停滞期の解消考察

- 人真似
    言語習得者のMessageはある程度バラけているため，これを真似すれば即時に停滞期までスキップできる．Messageのダブリング解決に時間を多くかけられる．
    色んな人のMessageを真似することでいいとこ取りできる？
- 語彙辞書を参照する．レキシコン
    新しく言葉を作るときに，既存の言葉を参照する．これにより，ダブリングを防げる．


## 目的

CoLingoは、複数のエージェントが関与する環境での言語創発実験を促進するためのオープンソースライブラリです。このライブラリの主な目的は、言語創発研究の新しい領域を探求するのを支援することです。

## 背景

既存の言語創発研究のほとんどは、2人のエージェント間のシグナリングゲームに基づいていますが、実際の世界のシナリオでは、2人以上のエージェント間での協力がしばしば発生します。したがって、そのような状況を模倣できる言語創発実験への需要が高まっています。CoLingoは、三人以上のエージェントが関与する環境で、より現実的な言語創発研究の状況を提供することを目指して設計されています。既存の言語創発研究やライブラリに比べて、CoLingoは柔軟性と拡張性のある設計を提供します。

## 概要

このライブラリを使用して行われる実験では、まず、環境内のエージェント、実験で使用するデータセット、各イテレーションで実行されるタスクが生成されます。その後、これらのタスクが繰り返し実行されます。

## 要素

- **エージェント**: エージェントは、タスクからの入力を処理し、出力を返すモデルを持っています。彼らがタスクから入力を受け取るとき、そのタスクでの彼らの役割も受け取り、それに応じてモデルの振る舞いを切り替えます。

- **タスク**: タスクは、実験全体を通じて繰り返し実行されるプロセスです。これは、エージェントの学習、メトリクスの計算、モデルの保存など、何でも可能です。

- **ネットワーク**: ネットワークはエージェント間の通信チャネルを定義します。これはグラフ構造で、ノードはエージェントを、エッジはエージェント間の通信パスを表します。一部のタスクではネットワークが必要になる場合があります。



## Installing

```
git clone https://github.com/gizmrkv/CoLingo.git
cd CoLingo
poetry lock
poetry install
```